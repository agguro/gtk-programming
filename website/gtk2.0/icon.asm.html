<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="Generator" content="Kate, the KDE Advanced Text Editor" />
<title>icon.asm</title>
</head>
<!-- Highlighting: "Intel x86 (NASM)" -->
<body>
<pre style='color:#1f1c1b;background-color:#ffffff;'>
<span style='color:#898887;'>; Name        : icon.asm</span>
<span style='color:#898887;'>;</span>
<span style='color:#898887;'>; Build       : aclocal &amp;&amp; autoconf &amp;&amp; automake --add-missing --foreign</span>
<span style='color:#898887;'>;               mkdir build</span>
<span style='color:#898887;'>;               cd build</span>
<span style='color:#898887;'>;               ../configure</span>
<span style='color:#898887;'>;               make</span>
<span style='color:#898887;'>;</span>
<span style='color:#898887;'>; Description : a simple window with application icon</span>
<span style='color:#898887;'>;</span>
<span style='color:#898887;'>; Remark      : when copying the application to another location you need to copy the image file 'logo.png' with it in</span>
<span style='color:#898887;'>;               the same directory.</span>
<span style='color:#898887;'>;</span>
<span style='color:#898887;'>; Source      : http://zetcode.com/gui/gtk2/firstprograms/</span>

<b>bits</b><span style='color:#b08000;'> 64</span>

[list -]
    <b>extern</b>    exit
    <b>extern</b>    printf
    <b>extern</b>    gtk_init
    <b>extern</b>    gtk_window_new
    <b>extern</b>    gtk_window_set_title
    <b>extern</b>    gtk_window_set_default_size
    <b>extern</b>    gtk_window_set_position
    <b>extern</b>    gtk_window_set_icon
    <b>extern</b>    gtk_widget_show
    <b>extern</b>    gtk_main
    <b>extern</b>    gtk_main_quit
    <b>extern</b>    g_signal_connect_data
    <b>extern</b>    gdk_pixbuf_new_from_file
    <span style='color:#006e28;'>%define   GTK_WINDOW_TOPLEVEL   0</span>
    <span style='color:#006e28;'>%define   GTK_WIN_POS_CENTER    1</span>
[list +]

<b>section</b> .rodata
<span style='color:#644a9b;'>    szTitle:</span>        <span style='color:#0057ae;'>db</span>   <span style='color:#bf0303;'>&quot;icon&quot;</span>,<span style='color:#b08000;'>0</span>
<span style='color:#644a9b;'>    szDestroy:</span>      <span style='color:#0057ae;'>db</span>   <span style='color:#bf0303;'>&quot;destroy&quot;</span>,<span style='color:#b08000;'>0</span>
<span style='color:#644a9b;'>    szFile:</span>         <span style='color:#0057ae;'>db</span>   <span style='color:#bf0303;'>&quot;agguro.png&quot;</span>,<span style='color:#b08000;'>0</span>                   <span style='color:#898887;'>;must reside in the same directory</span>
<span style='color:#644a9b;'>    szErrPixbuf:</span>    <span style='color:#0057ae;'>db</span>   <span style='color:#bf0303;'>&quot;ERROR loading %s&quot;</span>,<span style='color:#b08000;'>10</span>,<span style='color:#b08000;'>0</span>

<b>section</b> .data
<span style='color:#644a9b;'>    window:</span>         <span style='color:#0057ae;'>dq</span>   <span style='color:#b08000;'>0</span>
<span style='color:#644a9b;'>    icon:</span>           <span style='color:#0057ae;'>dq</span>   <span style='color:#b08000;'>0</span>
<span style='color:#644a9b;'>    pixbuffer:</span>      <span style='color:#0057ae;'>dq</span>   <span style='color:#b08000;'>0</span>
<span style='color:#644a9b;'>    error:</span>          <span style='color:#0057ae;'>dq</span>   <span style='color:#b08000;'>0</span>
    
<b>section</b> .text
    <b>global</b> _start

<span style='color:#644a9b;'>_start:</span>
    <span style='color:#898887;'>;init gtk</span>
    <b>xor</b>     <b>rsi</b>,<b>rsi</b>                                <span style='color:#898887;'>;argv</span>
    <b>xor</b>     <b>rdi</b>,<b>rdi</b>                                <span style='color:#898887;'>;argc</span>
    <b>call</b>    gtk_init
    <span style='color:#898887;'>;create a new window</span>
    <b>mov</b>     <b>rdi</b>,GTK_WINDOW_TOPLEVEL
    <b>call</b>    gtk_window_new
    <b>mov</b>     <span style='color:#0057ae;'>qword</span> [window],<b>rax</b>
    <span style='color:#898887;'>;set the title</span>
    <b>mov</b>     <b>rdi</b>,<span style='color:#0057ae;'>qword</span> [window]
    <b>mov</b>     <b>rsi</b>,szTitle
    <b>call</b>    gtk_window_set_title
    <span style='color:#898887;'>;set the size</span>
    <b>mov</b>     <b>rdi</b>,<span style='color:#0057ae;'>qword</span> [window]
    <b>mov</b>     <b>rsi</b>,<span style='color:#b08000;'>230</span>
    <b>mov</b>     <b>rdx</b>,<span style='color:#b08000;'>150</span>
    <b>call</b>    gtk_window_set_default_size
    <span style='color:#898887;'>;set the position</span>
    <b>mov</b>     <b>rdi</b>,<span style='color:#0057ae;'>qword</span> [window]
    <b>mov</b>     <b>rsi</b>,GTK_WIN_POS_CENTER
    <b>call</b>    gtk_window_set_position
    <span style='color:#898887;'>;load imagefile in a pixbuffer</span>
    <b>mov</b>     <b>rdi</b>,szFile
    <b>mov</b>     <b>rsi</b>,error
    <b>call</b>    gdk_pixbuf_new_from_file
    <b>mov</b>     <span style='color:#0057ae;'>qword</span> [pixbuffer],<b>rax</b>
    <b>and</b>     <b>rax</b>,<b>rax</b>
    <b>jnz</b>     .no_icon_file_error
    <span style='color:#898887;'>;print error to terminal if there was an error</span>
    <b>mov</b>     <b>rsi</b>,szFile
    <b>mov</b>     <b>rdi</b>,szErrPixbuf
    <b>xor</b>     <b>rax</b>,<b>rax</b>
    <b>call</b>    printf
    <b>jmp</b>     .skiploadicon
    <span style='color:#898887;'>;if no erro then the image is in the pixel buffer</span>
    <span style='color:#898887;'>;and we can set the icon</span>
<span style='color:#644a9b;'>.no_icon_file_error:</span>     
    <b>mov</b>     <b>rdi</b>,<span style='color:#0057ae;'>qword</span> [window]
    <b>mov</b>     <b>rsi</b>,<span style='color:#0057ae;'>qword</span> [pixbuffer]
    <b>call</b>    gtk_window_set_icon
<span style='color:#644a9b;'>.skiploadicon:</span>
    <span style='color:#898887;'>;connect signal destroy with gtk_main_quit event handler</span>
    <b>xor</b>     <b>r9d</b>,<b>r9d</b>                  <span style='color:#898887;'>; combination of GConnectFlags </span>
    <b>xor</b>     <b>r8d</b>,<b>r8d</b>                  <span style='color:#898887;'>; a GClosureNotify for data</span>
    <b>xor</b>     <b>rcx</b>,<b>rcx</b>                  <span style='color:#898887;'>; pointer to the data to pass</span>
    <b>mov</b>     <b>rdx</b>,gtk_main_quit        <span style='color:#898887;'>; pointer to the handler</span>
    <b>mov</b>     <b>rsi</b>,szDestroy            <span style='color:#898887;'>; pointer to the signal</span>
    <b>mov</b>     <b>rdi</b>,<span style='color:#0057ae;'>qword</span>[window]        <span style='color:#898887;'>; pointer to the widget instance</span>
    <b>call</b>    g_signal_connect_data    <span style='color:#898887;'>; the value in RAX is the handler, but we don't store it now</span>
    <span style='color:#898887;'>;show the window</span>
    <b>mov</b>     <b>rdi</b>,<span style='color:#0057ae;'>qword</span> [window]
    <b>call</b>    gtk_widget_show
    <span style='color:#898887;'>;enter process loop</span>
    <b>call</b>    gtk_main
    <span style='color:#898887;'>;exi program</span>
    <b>xor</b>     <b>rdi</b>,<b>rdi</b>
    <b>call</b>    exit
</pre>
</body>
</html>
